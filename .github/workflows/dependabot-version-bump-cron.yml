name: Dependabot version bump cron

on:
  schedule:
    - cron: "0 9 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: dependabot-version-bump-cron
  cancel-in-progress: false

jobs:
  bump-version-if-needed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        run: |
          sudo apt-get update -y
          sudo add-apt-repository -y ppa:ubuntuhandbook1/ffmpeg7
          sudo apt-get update -y
          sudo apt-get install -y \
            jq \
            pkg-config \
            libglib2.0-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            libfuse2 \
            zsync \
            ffmpeg \
            libavcodec-dev \
            libavformat-dev \
            libavutil-dev \
            libswscale-dev \
            libswresample-dev

      - name: Set up git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Detect whether bump is needed
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          git fetch --tags origin main

          current_version=$(jq -r '.version' package.json)
          latest_tag=$(git tag --list 'reelix-v*' --sort=-v:refname | head -n 1 || true)

          if [ -z "$latest_tag" ]; then
            echo "needs_bump=false" >> "$GITHUB_OUTPUT"
            echo "reason=no_release_tag" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$latest_tag" != "reelix-v${current_version}" ]; then
            echo "needs_bump=false" >> "$GITHUB_OUTPUT"
            echo "reason=version_already_ahead_of_latest_release" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          range="${latest_tag}..origin/main"
          dependabot_count=$(git log "$range" --pretty='%an|%ae' | grep -Eci 'dependabot\[bot\]|dependabot\[bot\]@users\.noreply\.github\.com' || true)

          if [ "$dependabot_count" -gt 0 ]; then
            echo "needs_bump=true" >> "$GITHUB_OUTPUT"
            echo "reason=dependabot_commits_detected_since_latest_release" >> "$GITHUB_OUTPUT"
          else
            echo "needs_bump=false" >> "$GITHUB_OUTPUT"
            echo "reason=no_dependabot_commits_since_latest_release" >> "$GITHUB_OUTPUT"
          fi

      - name: Bump app version (bug)
        if: steps.detect.outputs.needs_bump == 'true'
        run: bash scripts/bump-version.sh bug

      - name: Read bumped version
        if: steps.detect.outputs.needs_bump == 'true'
        id: bumped_version
        shell: bash
        run: |
          echo "version=$(jq -r '.version' package.json)" >> "$GITHUB_OUTPUT"

      - name: Create version bump PR
        if: steps.detect.outputs.needs_bump == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: chore/dependabot-daily-version-bump
          delete-branch: true
          commit-message: "chore: daily version bump to v${{ steps.bumped_version.outputs.version }} after dependabot updates"
          title: "chore: daily version bump to v${{ steps.bumped_version.outputs.version }}"
          body: |
            Automated version bump because Dependabot-originated commits were detected on `main` since the latest release tag.
          add-paths: |
            package.json
            package-lock.json
            src-tauri/Cargo.toml
            src-tauri/Cargo.lock
            src-tauri/tauri.conf.json

      - name: Log decision
        run: |
          echo "needs_bump=${{ steps.detect.outputs.needs_bump }}"
          echo "reason=${{ steps.detect.outputs.reason }}"
