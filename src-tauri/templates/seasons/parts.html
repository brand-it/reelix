{% macro part_selector(part, selected_disk) %}
  <div class="row g-2 align-items-center mb-2">
    <label for="part{{ part }}" class="col-auto col-form-label fw-bold">Part {{ part }}*</label>
    <div class="col">
      <select id="part{{ part }}" data-episode-target="selector" data-episode-part="{{ part }}"
              data-action="episode#titleSelected" class="form-select form-select-sm" data-episode-previous-value="">
        <option value="">Select a Disk Title</option>
        {% for title_info in selected_disk.clone_titles() %}
          <option value="{{ title_info.id }}">
            {% if let Some(description) = title_info.description %}
              {{ description }}
            {% endif %}
          </option>
        {% endfor %}
      </select>
    </div>
  </div>
{% endmacro %}

{% macro episode_part_selector(episode, part, selected_disk, job) %}
  <div class="row g-2 align-items-center mb-2">
    {% let previous_value = crate::templates::find_previous_value(episode, part, job) %}
    <label for="part{{ episode.id }}-{{ part }}" class="col-auto col-form-label fw-bold">Part {{ part }}*</label>
    <div class="col">
      <select name="part{{ episode.id }}-{{ part }}" data-episode-target="selector" data-episode-part="{{ part }}"
              data-action="episode#titleSelected" class="form-select form-select-sm"
              data-episode-previous-value="{% match previous_value %}{% when Some with (v) %}{{ v }}{% when None %}{% endmatch %}">
        <option value="">Select a Disk Title</option>
        {% for title_info in selected_disk.clone_titles() %}
          {% if crate::templates::is_selected_title(episode, part, title_info, job) %}
            <option value="{{ title_info.id }}" selected>
              {% match title_info.description %}{% when Some with (d) %}{{ d }}{% when None %}Untitled{% endmatch %}
            </option>
          {% elif crate::templates::job_contains_episode_for_title(episode, title_info, job) %}
            <option value="{{ title_info.id }}">
              {% match title_info.description %}{% when Some with (d) %}{{ d }}{% when None %}Untitled{% endmatch %}
            </option>
          {% endif %}
        {% endfor %}
      </select>
    </div>
  </div>
{% endmacro %}

<div class="{{ self.selector_class() }} pb-3">
  {% if let Some(disk) = selected_disk %}
    {% if disk.any_titles() %}
      {% if episode.is_some() && job.is_some() %}
        {% let episode = episode.as_ref().unwrap() %}
        {% let job = job.as_ref().unwrap() %}
        {% call episode_part_selector(episode, 1, disk, job) %}
        {% call episode_part_selector(episode, 2, disk, job) %}
        {% call episode_part_selector(episode, 3, disk, job) %}
        {% call episode_part_selector(episode, 4, disk, job) %}
      {% else %}
        {% call part_selector(1, disk) %}
        {% call part_selector(2, disk) %}
        {% call part_selector(3, disk) %}
        {% call part_selector(4, disk) %}
      {% endif %}
      <small class="text-muted d-block mt-1">
        * Part 1 is required; additional parts are optional.
      </small>
    {% else %}
      <div class="d-flex justify-content-center align-items-center py-3">
        <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
        <span class="ms-2">Loading title infoâ€¦</span>
      </div>
    {% endif %}
  {% endif %}
</div>
