{% macro movie_card_with_title(title, disk, job, has_video,
video_duration_range) %}
<div class="mb-3 col movie-card" id="movie-card-{{ title.id }}">
  <div
    class="card h-100 {% if has_video && title.within_range(video_duration_range) && title.has_chapters() %}border-success border-2 shadow-sm{% endif %}">
    <div
      class="card-header d-flex align-items-center {% if has_video && title.within_range(video_duration_range) && title.has_chapters() %}bg-success-subtle{% endif %}">
      <div class="overflow-hidden">
        <i class="fad fa-film text-muted"></i>
        <span class="fw-semibold me-2">{{
          title.filename.as_deref().unwrap_or("") }}</span>
      </div>
      <span class="badge bg-secondary-subtle text-secondary border me-1">
        {{ title.chapter_count.unwrap_or(0) }}
        {% if title.chapter_count.unwrap_or(0) < 2 %}
        Chapter
        {% else %}
        Chapters
        {% endif %}
      </span>
      {% if has_video && title.within_range(video_duration_range) &&
      title.has_chapters() %}
      <span class="badge bg-success text-white flex-shrink-0 ms-auto"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        data-bs-title="This title is the best match for the selected video.">
        <i class="fas fa-check-circle me-1"></i>Best Match
      </span>
      {% elif has_video && title.without_chapters() &&
      title.within_range(video_duration_range) %}
      <span class="badge bg-warning text-dark flex-shrink-0 ms-auto"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        data-bs-title="Missing chapters; this is odd but possible issue.">
        <i class="fas fa-exclamation-triangle me-1"></i>Possible Match
      </span>
      {% endif %}
    </div>

    {% if let Some(job) = job %}
    {% if job.matching_title(&title) && job.is_processing() %}
    <div class="progress"
      role="progressbar"
      aria-valuenow="{{ job.progress.percent }}"
      aria-valuemin="0"
      aria-valuemax="100"
      style="height: 3px">
      <div
        class="progress-bar bg-success progress-bar-striped progress-bar-animated"
        style="width: {{ job.progress.percent }}%"></div>
    </div>
    {% elif job.matching_title(&title) && job.is_finished() %}
    <div class="progress"
      role="progressbar"
      aria-valuenow="100"
      aria-valuemin="0"
      aria-valuemax="100"
      style="height: 3px">
      <div class="progress-bar" style="width: 100%"></div>
    </div>
    {% else %}
    <div class="progress"
      role="progressbar"
      aria-valuenow="0"
      aria-valuemin="0"
      aria-valuemax="100"
      style="height: 3px">
      <div class="progress-bar" style="width: 0%"></div>
    </div>
    {% endif %}
    {% else %}
    <div class="progress"
      role="progressbar"
      aria-valuenow="0"
      aria-valuemin="0"
      aria-valuemax="100"
      style="height: 3px">
      <div class="progress-bar" style="width: 0%"></div>
    </div>
    {% endif %}

    <div class="card-body">
      <div class="row g-2 mb-3">
        <div class="col-6">
          <div class="d-flex align-items-center text-muted small">
            <i class="fas fa-clock me-2" tooltip="Duration"></i>
            <span class="overflow-hidden">{{
              title.duration.as_deref().unwrap_or("N/A") }}</span>
          </div>
        </div>
        <div class="col-6">
          <div class="d-flex align-items-center text-muted small">
            <i class="fas fa-database me-2" tooltip="File Size"></i>
            <span class="overflow-hidden">{{
              title.size.as_deref().unwrap_or("N/A") }}</span>
          </div>
        </div>
        <div class="col-6">
          <div class="d-flex align-items-center text-muted small">
            <i class="fas fa-language me-2" tooltip="Language"></i>
            <span class="overflow-hidden">{{
              title.lang.as_deref().unwrap_or("N/A") }}</span>
          </div>
        </div>
        <div class="col-6">
          <div class="d-flex align-items-center text-muted small">
            <i class="fas fa-stream me-2" tooltip="Segment Map"></i>
            <span class="overflow-hidden">{{
              title.segment_map.as_deref().unwrap_or("N/A") }}</span>
          </div>
        </div>
      </div>

      <div class="d-grid">
        {% if let Some(job) = job %}
        {% if job.matching_title(&title) && job.is_processing() %}
        <button class="btn btn-primary btn-sm" disabled>
          <i class="fad fa-compact-disc fa-spin me-2"></i>Processing...
        </button>
        {% else %}
        <button class="btn btn-outline-secondary btn-sm" disabled>
          <span class="placeholder col-12"></span>
        </button>
        {% endif %}
        {% else %}
        <a class="btn btn-success btn-sm"
          data-rip-movie-target="link"
          data-action="click->rip-movie#rip"
          data-disk-id="{{ disk.id }}"
          data-title-id="{{ title.id }}"
          tooltip="Create MKV From Title">
          <i class="fad fa-compact-disc me-2"></i>Create MKV
        </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endmacro movie_card_with_title %}

<div class="text-center row" id="movie-cards-selector"
  data-controller="bootstrap-tooltip">
  {% if let Some(disk) = selected_disk %}
  {% if disk.any_titles() %}
  {% if let Some(v) = video %}
  {% for title in disk.titles_sorted(v.runtime_seconds()) %}
  {% call movie_card_with_title(title=title, disk=disk, job=job,
  has_video=true, video_duration_range=v.runtime_range())
  %}
  {% endfor %}
  {% else %}
  {% for title in disk.clone_titles() %}
  {% call movie_card_with_title(title=title, disk=disk, job=job,
  has_video=false, video_duration_range=None) %}
  {% endfor %}
  {% endif %}
  {% else %}
  <div class="d-flex justify-content-center align-items-center py-3">
    <i class="fad fa-spinner fa-pulse"></i>
    <span class="ms-2">Loading {{ disk.name }} Titlesâ€¦</span>
  </div>
  {% for _ in 0..6 %}
  <div class="mb-3 col movie-card">
    <div class="card h-100">
      <div
        class="card-header d-flex justify-content-between align-items-center placeholder-glow">
        <i class="fad fa-film text-muted flex-shrink-0"></i>
        <span class="placeholder col-6"></span>
        <span class="placeholder col-2 flex-shrink-0"></span>
      </div>
      <div class="progress" style="height: 3px">
        <div class="progress-bar" style="width: 0%"></div>
      </div>
      <div class="card-body placeholder-glow">
        <div class="row g-2 mb-3">
          <div class="col-6">
            <div class="d-flex align-items-center text-muted small">
              <i class="fas fa-clock me-2"></i>
              <span class="placeholder col-8"></span>
            </div>
          </div>
          <div class="col-6">
            <div class="d-flex align-items-center text-muted small">
              <i class="fas fa-database me-2"></i>
              <span class="placeholder col-7"></span>
            </div>
          </div>
          <div class="col-6">
            <div class="d-flex align-items-center text-muted small">
              <i class="fas fa-language me-2"></i>
              <span class="placeholder col-5"></span>
            </div>
          </div>
          <div class="col-6">
            <div class="d-flex align-items-center text-muted small">
              <i class="fas fa-stream me-2"></i>
              <span class="placeholder col-9"></span>
            </div>
          </div>
        </div>
        <div class="d-grid">
          <button class="btn btn-outline-secondary btn-sm" disabled>
            <span class="placeholder col-12"></span>
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
  {% endif %}
  {% endif %}
</div>
